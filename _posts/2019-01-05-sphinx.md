---
layout: post
title: "Documenting Python Packages with Sphinx and ReadTheDocs"
date: 2019-01-05
description: "Writing and generating documentation for python packages using Sphinx, and hosting and automatically building the documentation with ReadTheDocs."
img_url: ???
github_url: ???
tags: [python, tools]
comments: true
published: false
---

TODO: intro, idea of html docs from rst files, auto-api docs generation, etc

**Outline**

-   [Installation](#installation)
-   [Setup](#setup)
-   [Writing the documentation](#writing-the-documentation)
    -   [File hierarchy](#file-hierarchy)
etc...


## Installation

Installing Sphinx is pretty easy.  Just install via `pip` with:

```
pip install sphinx
```


## Setup

Let's assume your project's main folder is `project-name`.  Create a folder for the documentation within that folder (called, say, `docs`).  In a terminal, navigate to that `docs` folder and run

```
sphinx-quickstart
```

and answer all the questions.  Make sure to say yes to enabling the autodoc extension!  

This will create an `index.rst` file, and a `conf.py` file.  The `index.rst` file contains the home page of your documentation in reStructuredText format.  reStructuredText is sort of like Markdown, but made specifically for writing technical documentation.  The `conf.py` file is a python script which sets configuration options for building your documentation.


## Writing the documentation

The `index.rst` file, which was created in your `docs` folder, is the main page of your documentation.  In that file you can write content, and define sub-pages which have their own content (and sub-pages of their own).

To write the documentation, we'll use [reStructuredText](http://docutils.sourceforge.net/rst.html)(reST).  reST is similar to Markdown in that it is easily readable in plain text form (though honestly not as easily readable as Markdown), but is built with the intention of converting the raw text to formatted html (or pdf, or something).

The main difference between Markdown and reST are "roles" and "directives" (in addition to a few other syntactic differences we'll get to in a bit).  Roles are used for signifying things like inline math expressions, cross-references, and arguments to directives.  Directives are blocks of explicit markup for things like the table of contents, images, displayed math equations, and tables.


### File hierarchy

Each page in your documentation can contain content and links to sub-pages, defining a hierarchy of documentation pages
(though it is possible to have isolated pages to which other pages in the main hierarchy link).  The sub-pages for a given pages are listed in a directive called the `toctree` (table of contents tree).  

The `toctree` for a documentation page contains a list of subpages for that page.  List elements in the toctree are filenames (minus the .rst extension) of other pages to link to.  To make those pages, create .rst files with those filenames, and add a title (the `toctree` in a parent page will list the page title, not the filename).

For example, an `index.rst` documentation home page may contain a `toctree` which looks like this:

```
.. toctree::
   getting_started
   tutorials
   api
```

If you create the files `getting_started.rst`, `tutorials.rst`, and `api.rst`, then the home page of your documentation will link to those three pages.

You can can change the behavior of a `toctree` by adding different roles as "arguments".  For example, to set the caption of the `toctree` to "Contents", you can add the `:caption:` role, followed by the desired caption:

```
.. toctree::
   :caption: Contents
   getting_started
   tutorials
   api
```

You can also set the maximum depth that the table of contents will display by setting the `maxdepth` role:

```
.. toctree::
   :caption: Contents
   :maxdepth: 2
   etc...
```

Setting the maxdepth to 1 lists only this page's sub-pages; setting the maxdepth to 2 also lists each subpage's subpages; and so on.

By default, Spinx adds a side bar with the table of contents, but also displays the table of contents in the main page.  If you want to hide the table of contents in the main page (but still show it in the side bar), you can add the `:hidden:` role:

```
.. toctree::
   :caption: Contents
   :maxdepth: 2
   :hidden:
   etc...
```


### Syntax

But having a document hierarchy isn't very useful without adding content to the documents!  Titles and headings can be added by underlining the title/heading with certain characters.  You can actually use any characters you want, but the convention is to use:

- `=` for page titles,
- `-` for sections,
- `^` for subsections, and
- `"` for subsubsections.

You can add text in the normal way (by just adding text!).  Surround text with one asterisk for italics, two asterisks for boldface, and *double* backquotes for inline code (aka 'grave accent marks' - single backquotes are used in markdown to signify inline code).  So, for example:

```
Title
=====

Here is some normal text

Section
-------

*Italic* text

Subsection
^^^^^^^^^^

**Bold** text

Subsubsection
"""""""""""""

``Code sample``
```

Bulleted lists use asterisks, numbered lists use numbers, and nesting is done with indentation, like Markdown (though nested lists need to be surrounded by blank lines):

```
* Bulleted
* list

  * nested
  * list

* con't

1. Numbered
2. list
```

For hyperlinks, use:

```
`Link text <http://www.link-address.com>`_
```

Commented lines begin with two periods and a space (like a directive w/o the double colons):

```
.. I'm a comment!
```

And multiline comments are also like directives w/o the colons:

```
..
   I am
   a multiline

   comment
```

Sphinx has a page with [more info](http://www.sphinx-doc.org/en/1.6/rest.html) on sphinx-style reStructuredText syntax.


### Math

Sphinx supports including LaTeX-style equations in the documentation's .rst files.  There are a few different ways to do this, but I prefer using MathJax via the mathjax extension.  To enable the mathjax extension, in your `conf.py` file, add the string `'sphinx.ext.mathjax'` to the `extensions` list.  Assuming that during `sphinx-quickstart` you said yes to enabling the autodoc extension, there should be a variable in `conf.py` containing a list of extensions to use which looks like this:

```
extensions = [
    'sphinx.ext.autodoc',
    #optionally other extensions...
]
```

To enable the mathjax extension, just add `'sphinx.ext.mathjax'` to that list:

```
extensions = [
    'sphinx.ext.autodoc',
    'sphinx.ext.mathjax',
    #optionally other extensions...
]
```

It may already be there if you said yes to enabling the mathjax extension during `sphinx-quickstart`.

Now you can insert LaTeX-style math expressions and equations in your .rst files and they'll be rendered in the built html documentation using mathjax!

Inline math can be inserted using the `:math:` role, and then an expression enclosed in single backquotes (aka 'grave accent marks', used in markdown to signify inline code).  For example, 

```
... the mean (:math:`\mu`) of ...
```

will render as:

... the mean ( \\( \mu \\) ) of ...

Displayed math (an equation or expression which has its own line) can be inserted using the `.. math::` directive and indentation:

```
.. math::

    y \sim \mathcal{N}(0, 1)
```

which renders as

$$
y \sim \mathcal{N}(0, 1)
$$

You can also reference equations using the `:label:` and `:eq:` roles:

```
.. math:: \beta \sim \text{Poisson}(\lambda=5)
   :label: beta_prior

The prior on :math:`\beta` is a Poisson distribution with rate parameter of 5 :eq:`beta_prior`.
```

### Code

As mentioned above, inline code can be done by enclosing the text in double backquotes:

```
Here's some ``inline code``.
```

Which renders as:

Here's some `inline code`.

Displayed code blocks are a bit different from Markdown.  To make a displayed code block, you can use a [literal block](http://docutils.sourceforge.net/docs/ref/rst/restructuredtext.html#quoted-literal-blocks):

```
Here's some normal text. ::

  # And here's some code
  for i in range(5):
    print(i)

  # code block keeps going until un-indent
  
Normal text again
```

which renders as:

Here's some normal text.
```
# And here's some code
for i in range(5):
  print(i)

# code block keeps going until un-indent
```
Normal text again


### Cross-referencing


######################################################## HERE

TODO: how to reference other files/modules


## Building the Documentation
To build the docs from the rst files, run

```
sphinx-build -b html sourcedir builddir
```

where `sourcedir` is the folder w/ the sphinx doc files, and `builddir` is the directory in which to put the output html.  The `-b` flag is what type you want to build the docs as (html).


## Autodoc extension

The [autodoc extension](http://www.sphinx-doc.org/en/1.6/ext/autodoc.html) for sphinx can automatically generate API reference doc pages from the docstrings in your python code.

TODO: more...

To enable the autodoc extension, in your `conf.py` file, add the string `'sphinx.ext.autodoc'` to the `extensions` list (this should have already been done if you answered yes to enabling the autodoc extension during `sphinx-quickstart`).

You also need to add the path to the folder containing your module's source code.  Also in `conf.py`, add the lines

```python
import os
import sys
sys.path.insert(0, os.path.abspath('../package-name'))
```

The above assumes your project directories look like this:

```
package-name/
    package-name/
        python files, etc
    docs/
        conf.py
        rst files, other docs stuff
```


### Automodule and autoclass

Then in the documentation's .rst files, you can use the `automodule` directive:

```
.. automodule:: package_name.module
   :members:
```

which will insert an automatically generated API reference for the entire module.  The `:members:` role makes autodoc generate documentation for each member (function, class, or constant) in that module, and for each member of each class (attributes and methods).

To insert an automatically-generated API reference only for one specific class, you can use the `autoclass` directive:

```
.. autoclass:: package_name.module.class_name
   :members:
   :inherited-members:
   :exclude-members: members, to, exclude
```

which lists all attributes and methods, except those in the `exclude-members` list.

The `:inherited-members:` role causes members which are inherited to also be included in the documentation (this role can also be used with `automodule`).

To include only specific members, instead of specifying `:exclude-members:`, you can add a list of members you *do* want to include after `:members:`, eg: `:members: members, to, include`.

The default is to not document private members (attribs or methods starting with an underscore, like `_private_method`).  To force autodoc to also include those private members in the generated API documentation, add the `:private-members:` role.

You can also add `:special-members:` to include "special" functions - functions with two underscores at the beginning and end, such as `__add__`, `__sub__`, and `__init__`.

If you want to have more control over how the docs are structured, there are also `autofunction`, `automethod`, and `autoattribute` directives.  These are used in the same way as `automodule` and `autoclass`, but they only insert the documentation for specific functions, methods, or attributes. 


### Mock importing packages

To build the docs, Sphinx needs to actually import your package.  But you might not have all dependancies installed on the machine you're building the docs on (for example, I don't have `tensorflow` and `tensorflow-probability` installed on my laptop).  To make autodoc "mock" import these packages (don't actually import the packages but allow the code to run), add a variable called `autodoc_mock_imports` to your `conf.py` file containing a list of packages to mock import

```
autodoc_mock_imports = ['packages', 'to', 'mock']
```

For example, to mock import `tensorflow` and `tensorflow-probability`, add:

```
autodoc_mock_imports = ['tensorflow', 'tensorflow_probability']
```

This allows you to build your documentation on machines where you don't have the full dependency stack installed and set up.


### Including Math in docstrings

Including math expressions or equations in your docstrings can be done in the same way as for .rst files ([see above](#math)).  However, for docstrings which contain math, it's a good idea to either make the docstring a Python raw string (by putting `r` in front of the docstring, like so: `r"""Docstring..."""`), or to double all backslashes.  Otherwise the escaped characters are passed to autodoc instead of the backslash literals.  I've found that unless you use string literals or double backslashes, things (somehow) work fine for displayed math, but not for inline math.


## Napoleon extension

The [Napoleon extension](http://www.sphinx-doc.org/en/1.6/ext/napoleon.html) for Sphinx allows for NumPy/Google style docstrings instead of using the hard-to-read reStructuredText in your docstrings.  Napoleon is a pre-processor which takes your NumPy or Google-style docstrings and converts them to reStructuredText.

TODO: compare the three types of docstrings.

### Enabling Napoleon

To enable the Napoleon extension, in your sphinx `conf.py` file, add the string `'sphinx.ext.napoleon'` to the `extensions` list.  So, previously (after enabling autodoc), my `conf.py` file contained:

```
extensions = [
    'sphinx.ext.autodoc',
    'sphinx.ext.intersphinx',
]
```

And to enable Napoleon, add the string to the list of extensions:

```
extensions = [
    'sphinx.ext.autodoc',
    'sphinx.ext.napoleon',
    'sphinx.ext.intersphinx',
]
```

### Configuring Napoleon

There are a few [configuration settings](http://www.sphinx-doc.org/en/1.5/ext/napoleon.html#configuration) that can be set for Napoleon.  Set their values by defining them in the `conf.py` file.  For example, to use Numpy-style docstrings and *not* Google-style docstrings, we can enable `napoleon_numpy_docstring` and disable `napoleon_google_docstring` by adding these two lines to `conf.py`:

```
napoleon_google_docstring = False
napoleon_numpy_docstring = True
```

Now you can run the `sphinx-build` command to generate documentation from NumPy or Google style docstrings.



## Intersphinx

TODO: referencing across projects w/ intersphinx extension


## Hosting Documentation on ReadTheDocs

TODO